# 세션? 토큰방식? 왜 최근에는 토큰방식이 우세해보일까 feat api gateway

웹으로 간단한 게시판을 구현해본 사람이라면 세션,토큰이라는 키워드를 들어본적이 있을 것이다
오늘은 다음의 주제에 대해서 무엇이 다르고 언제 무엇을 써야하는지에 대해서 **간단히** 정리해볼려고 한다

## HTTP

먼저 http에 대해서 간략히 알고가려 한다.
http는 우리가 웹에서 사용하는 프로토콜 즉 규약이다. 반드시 지켜야하는 것은 아니나 지키지 않는다면 통신시에 무슨 불이익이 있을지 모르니 지키는 것이 "권장"된다.

http가 **stateless라는** 이야기는 많이 들어보셨을 것이다.
기본적으로 유저의 정보가 어떻고를 저장하는데 http는 관심이 없다는 이야기이다.
하지만 우리가 사용하는 웹사이트에는 유저 정보를 저장하는 것이 필요하다

일반적으로 이때 세션,토큰 방식 두가지 중 하나를 선택하게 된다.

---

## 세션 VS 토큰 차이점
세션과 토큰 모두 인증부분을 구현할때 사용되는 기술이나 저장되는 주체가 중요하다.

세션의 경우 **세션 정보는 서버에 저장**되고 세션 id등 최소한의 가공된 정보를 서버가 클라이언트에 저장하는 식이다.

토큰의 경우 토큰의 가공은 똑같이 서버에서 진행하지만 **클라이언트에 토큰의 값 자체가 저장**이 된다는 점에서 차이가 있다.

세션의 경우에도 클라이언트에 세션 id등은 저장이 되고 토큰의 경우에도 클라이언트에 토큰자체가 저장이 되는데 **둘다 클라이언트에 저장되는것이 아닌가?** 할 수 있지만
(나는 이것이 헷갈려서 둘다 클라이언트에 저장된다고 생각했었다.)
헷갈린다면
본인이 구현해본 경험을 생각해볼때 토큰이 데이터베이스에 저장이 되는지 세션이 데이터베이스에 저장됐는지 한번 생각해보면 될 것 같다.

토큰은 토큰 그자체를 클라이언트에서 저장하고 그것을 서버에서 처리할때 문제가 없으면(parse시) 문제가 없는 것이라 서버에서 저장할 필요가 없고,

세션은 세션 그자체를 서버에서 항상 추적하고 있어야한다.
세션 id를 클라이언트에서 서버로 보냈을때 해당 세션이 존재하지않으면 안되는 것이다.


| 특징       | 세션(Session)                          | 토큰(Token)                          |
|------------|----------------------------------------|--------------------------------------|
| **저장 위치** | 서버                                   | 클라이언트                            |
| **확장성**   | 서버 메모리 사용, 확장 시 세션 공유 필요 | 서버 무상태, 확장성 우수               |
| **보안**     | 서버에서 상태 관리, 비교적 안전         | 클라이언트에서 상태 관리, 탈취 시 위험 |
| **유지 관리** | 서버에서 세션 만료 및 관리 필요        | 토큰 만료 시간 포함, 클라이언트가 관리 |
| **사용 예**  | 전통적인 웹 애플리케이션               | SPA, 모바일 애플리케이션, 분산 시스템  |



---
## 그래서 왜 토큰이 요즘에 우세한데?
![msa 예](https://velog.velcdn.com/images/praisebak/post/74ec9187-5f79-4000-834b-4541d1df1fc4/image.png)

MSA라는 키워드는 다들 들어보셨을 것이다. 
결론은 이 MSA 때문이다
세션은 결국 서버에서 그 세션값을 저장해야한다.

그런데 MSA는 각 서비스가 다른 서버라고 볼 수 있다.
무엇이 문제인지 알겠는가?
**모든 서비스들이 세션의 동기화를 진행해야한다는 것이다.
**

이 한 문장때문에 세션은 최근의 서비스에 쓰이지 않는 것이다.

사실, MSA가 아니어도 확장성을 생각했을때 토큰 방식이 우세인 것이다 
여기서는 이해를 위해 MSA의 경우를 가져왔다.

---
## 요약
세션은 서버에 저장됨.
토큰은 클라이언트에 저장됨.
최근에는 MSA 아키텍쳐가 우세임.(MSA아니어도 확장성이 중요)
MSA는 각 서비스가 각자 서버임

즉 각 서비스마다 세션이 동기화가 되야한다는 것임
= 비효율적임
위 이야기에서 핵심은 세션이 확장성이 좋지 않음을 의미함

### 따라서 토큰 WIN!!
> 
위는 일반적인 생각이고 실제 서비스에서는 MSA에 세션을 이용해야하는 경우도 있어 꼭 정답은 아니니 참고바랍니다.
MSA를 구축하는데 일반적으로는 토큰을 선호하는데 그 이유에 대해서 적어보았습니다.

---

## 조금 더 생각해볼 것
MSA 아키텍쳐에 토큰을 적용했을때, 각 서비스는 토큰을 인증하는 기능이 있어야한다..
  - 엄청난 중복 코드 예상
- 비대칭성? 대칭성?
  - 위 둘은 private key의 동기화 유무로 나뉠 수 있는데
  대칭성의 경우 private key를 통신을 나누는 두 서버가 가지고 있어야하며 
  비대칭성은 그렇지 않음
	
---
   
## 왜 API GATEWAY
- 만약 우리가 토큰 인증 방식을 MSA에 적용한다고 하자. 이때 스프링부트경우에 일반적인 로직을 생각하면 필터단에 jwt 토큰을 검증하는 로직을 넣어야한다. 
- MSA라면? YES. 모든 서비스에 jwt 토큰을 검증하는 로직을 넣어야한다. 
똑같은 코드가 모든 서비스에 추가된다는 것이다 jwt 토큰 검증 방식이 바뀐다면? 모든 서비스에 수정해야하는 참사가 일어난다.


해결할려면? 공통적으로 인증관련부분을 처리해주는 부분이 필요하다
= API GATEWAY에서 이를 해주자
AWS를 예로들면 Management에서 AWS Lambda등을 이용해서 설정할 수 있다
이부분 부터는 클라우드에서 관리해줘야하는 내용이 된다.

더이상 들어가기에는 내용이 길어질 것 같아 여기서 마무리하겠다.


---

## 느낀점
이번 내용을 조사하고 글을 쓰며 느낀점
- 사진찾기가 너무 귀찮다 그치만 이미지 없으면 쳐다도 보기 싫은걸...
- 확실히 글을 쓸려면 느낌만으로는 부족하고 근거, 왜가 필요해서 생각을 많이하게 된다.
- 설득을 할려면 설득력을 높이기 위해서 이것이 맞는 이유로 글을 쓰게 되는데, 알고보면 꼭 맞는 것은 아니라면? 사실 컴퓨터공학과에서는 이상은 있지만 현실과 다른 경우가 많기 때문에 이 경우가 우려됨 -> 방어적 글쓰기를 해야한다?...

### 이미지 소스 및 내용 참고 출처
https://www.sktenterprise.com/bizInsight/blogDetail/dev/2714
https://m42-orion.tistory.com/106
https://velog.io/@ddangle/Session세션과-Token토큰의-차이는


조금 더 생각해본 글
리프래쉬 토큰을 db에 저장해도 괜찮은걸까?
