토큰과 세션 내용을 적다보니 든 생각이
referesh token을 db에 저장해도 괜찮은 것일까 라는 생각이 들었다
어떤 문제가 있을까?


## 토큰의 특징
세션과 토큰 2가지가 있을때 토큰을 쓴다면 그 이유는 아마 확장성일 것이다.
필요에 의해 최근 경향은 서비스가 비대해짐에 따라 scale out방식을 선호하는데(서버를 여러개 추가한다),
이때 확장성이 중요하기 때문에 토큰이 채택되는 경우가 많다.


## refresh token?
우선 refresh token은 accessToken에 비해 만료시간이 길다.
그런데 둘다 클라이언트에 "그냥" 저장하면 보안상에 문제가 있고, 이를 위해 accessToken과 달리 reefresh token은 쿠키에 저장하고 Http Only(JS에서 접근 불가능함)와 Secure로 Https를 통해서 XSS 공격을 방지하여 클라이언트에서 저장을 한다.
여기까지는 문제가 없는데,
refresh token을 db에 저장하는 경우를 생각해보자

## refresh token을 db에 저장하면 뭐가 문젠데?
먼저, 간단하게 알아보면 우리는 확장성이 좋기때문에 토큰을 사용한다.
그런데 db에 저장하면, 이 확장성이 깨지는게 아닌가?

만약 MSA 아키텍쳐상에서 서비스가 여러개이고 db가 여러개이고 각각 서비스에서 인증을 한다고 가정시,
refresh token은 동기화가 되지 않게된다는 문제가 있다.

## 서버에 저장하면 보안상 좋은거 아님?
완전히 틀린말은 아니나, 서버에 저장해도 데이터베이스는 뚫릴 수 있기 때문에 이것이 항상 옳은 것은 아니라 사료된다.
Http Only와 Https로 어느정도 클라이언트에서 토큰이 탈취될 가능성은 적게 본다.

서버에 저장했을때 이점은 다음과 같을 것이라 사료된다.
- 만약 클라이언트 refresh token이 탈취됨 -> 이 refresh token으로 공격 -> db에서 확인해보니 없다? 이는 탈취된 것이기 때문에 모니터링이나 알람!!!
- 로직상에서 뭔가 서버에 저장해야하는 경우가 있을 수 있음(토큰 무효화 등)

그에 반면 단점은
- 오히려 db가 뚫려서 탈취될 가능성
- 확장성이 저하된다는 단점이 있다.


## 요약
역시 서바서!!
깔끔한 확장성을 위해서라면 db에 저장하지 않을 것 같고
(이 경우 api gateway에서 깔끔하게 인증 가능함)
보안이나 기능을 위해서라면 db에 저장할 것 같다
(이 경우 api gateway는 db접근 안하는게 권장되므로 다른 인증용 마이크로서비스가 필요하다)

